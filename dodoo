#!/usr/bin/env bash
POSITIONAL=()

# Used way too often
DCR='docker-compose run --rm'

# Basename
SELF="$(basename $0)"

# Parse input
SUBCOMMAND="$1"; shift

while [ $# -gt 0 ]
do
    key="$1"

    case $key in
        # Most used database names
        --core)
            DBNAME='odoodb'
            shift ;;
        --test)
            NOMIGRATE="-e MIGRATE=False"
            DBNAME='testdb'
            shift ;;
        --scratch)
            NOMIGRATE="-e MIGRATE=False"
            DBNAME='scratch'
            shift ;;

        # Custom name fallback
        -d|--dbname|--database)
            DBNAME="$2"
            shift 2 ;;

        --force)
            FORCE=1
            shift 2 ;;
        --nomig)
            NOMIGRATE="-e MIGRATE=False"
            shift ;;
        -p|--port)
            PORT="$2"
            shift 2 ;;
        -q|--quiet)
            if [ ! -z "$LOG_HANDLER" ]; then
                LOG_HANDLER="$LOG_HANDLER,werkzeug:WARNING"
            else
                LOG_HANDLER="werkzeug:WARNING"
            fi
            shift ;;
        -v|--version)
            VERSION="$2"
            shift 2 ;;
        *)
            POSITIONAL+=("$1")
            shift ;;
    esac
done

# Initialize defaults
setup_defaults() {
    CODE=0
    PORT=${PORT:-'80'}
    DBNAME=${DBNAME:-'odoodb'}
    if [ ! -z "$LOG_HANDLER" ]; then
        LOG_HANDLER="--log-handler=$LOG_HANDLER"
    fi
}

# Define subcommands
run() {
    setup_defaults
    dodoo_execute "$DCR -e DB_NAME=$DBNAME ${NOMIGRATE:-} -p $PORT:8069 odoo odoo --workers=0 ${LOG_HANDLER:-} $@"
}

migrate() {
    DBNAME=$1
    VERSION=$2

    if [ "$VERSION" = "latest" ]; then
        VERSION=$(echo $(egrep '^\s+- version:' "$(git rev-parse --show-toplevel)/odoo/migration.yml" | tail -n 1) | cut -d' ' -f3)
    fi

    if [ ! "$CODE" -eq 0 ]; then
        echo
        echo "Usage:   $SELF database_name x.y.z"
        echo "Example: $SELF odoodb 1.2.3"
        return $CODE
    fi

    echo "$SELF: Requested migration of $DBNAME to version $VERSION, processing..."
    dodoo_execute "$DCR -e MARABUNTA_FORCE_VERSION=$VERSION -e DB_NAME=$DBNAME odoo migrate"
}

scratch() {
    OVERRIDE_DB=${DBNAME:-''}
    setup_defaults
    if [ ! -z "$OVERRIDE_DB" ]; then
        DBNAME=$OVERRIDE_DB
    else
        DBNAME='testdb'
    fi
    MODULES_TO_INSTALL="-i $1"
    shift
    while [ $# -gt 0 ]; do
        MODULES_TO_INSTALL="$MODULES_TO_INSTALL -i $1"
        shift
    done
    dodoo_execute "$DCR -e DB_NAME=${DBNAME:='testdb'} odoo testdb-gen -i base $MODULES_TO_INSTALL"
}

probe() {
    if [ $# -eq 0 ]; then
        echo "$SELF: No module names provided, providing common feedback."
        dodoo_execute "$DCR odoo psql -c 'select state, count(state) from ir_module_module group by state'"
        exit 0
    fi
    setup_defaults
    echo "$SELF: Probing database $DBNAME for $# module(s)..."
    MODULES_TO_PROBE="'$1'"
    shift
    while [ $# -gt 0 ]; do
        MODULES_TO_PROBE="$MODULES_TO_PROBE, '$1'"
        shift
    done
    MODULES_TO_PROBE="($MODULES_TO_PROBE)"
    dodoo_execute "$DCR odoo psql -c 'select id, name, state from ir_module_module where name in $MODULES_TO_PROBE'"
}

install() {
    setup_defaults
    MODULES_TO_INSTALL=''
    for i in $POSITIONAL; do
        MODULES_TO_INSTALL="$MODULES_TO_INSTALL -i $i"
    done
    dodoo_execute "$DCR -e DB_NAME=${DBNAME:='testdb'} -e MIGRATE=False odoo odoo --stop-after-init $MODULES_TO_INSTALL"
}

upgrade() {
    setup_defaults
    MODULES_TO_UPGRADE=''
    for i in $POSITIONAL; do
        MODULES_TO_UPGRADE="$MODULES_TO_UPGRADE -u $i"
    done
    dodoo_execute "$DCR -e DB_NAME=${DBNAME:='testdb'} -e MIGRATE=False odoo odoo --stop-after-init $MODULES_TO_UPGRADE"
}

dropdb() {
    setup_defaults
    if [[ "$DBNAME" == "odoodb" && ! $FORCE -eq 1  ]]; then
        echo "$SELF: Refusing to drop odoodb; you must call dodoo with --force to do so."
        exit 1
    fi
    dodoo_execute "$DCR odoo dropdb $DBNAME"
    if [ $? -eq 0 ]; then
        echo "$SELF: $DBNAME seems to be dropped now."
    fi
}

shell() {
    setup_defaults
    dodoo_execute "$DCR -e DB_NAME=$DBNAME -e MIGRATE=False odoo odoo shell --shell-interface=ipython"
}

psql() {
    setup_defaults
    dodoo_execute "$DCR -e DB_NAME=$DBNAME odoo psql"
}

dblist() {
    dodoo_execute "$DCR odoo psql -c \l"
}

pytest() {
    # Where do we run?
    case $1 in
        # optionally prepend all suites with those base paths
        -e|--ex|--external)
            TESTING_RANGE='odoo/external-src/'
            shift ;;
        -l|--lo|--local)
            TESTING_RANGE='odoo/local-src/'
            shift ;;
        -b|--ba|--base)
            TESTING_RANGE='odoo/src/'
            shift ;;
        # else: provide full paths
    esac

    # resolve a database to run tests onto
    DBNAME=${DBNAME:='testdb'}
    if [[ "$DBNAME" == "odoodb" && ! "$FORCE" -eq 1 ]]; then
        echo "$SELF: Refusing to run tests on odoodb; please provide test database name or use --force."
        exit 1
    fi

    if [ $1 == '--recreate' ]; then
        shift
        dropdb
        TO_INSTALL=''
        for MODNAME in $@; do
            TO_INSTALL="$TO_INSTALL $(basename $MODNAME)"
        done
        scratch $TO_INSTALL
    fi

    # Positionals contain test suites now
    TESTSUITES="$TESTING_RANGE$1"
    shift
    while [ $# -gt 0 ]; do
        TESTSUITES="$TESTSUITES $TESTING_RANGE$1"
        shift
    done
    echo "$SELF: Testing $TESTSUITES..."
    dodoo_execute "$DCR -e DB_NAME=$DBNAME odoo pytest -s ${TESTSUITES:-}"
}

runtests() {
    setup_defaults
    dodoo_execute "$DCR -e DB_NAME=$DBNAME odoo runtests $@"
}

dodoo_execute() {
    if [ ! -z "$1" ]; then
        echo -e "\e[36m\e[1m:: $SELF: EXECUTING $1\e[0m"
        $1
    fi
}

# Run a desired action
if [ $SUBCOMMAND == 'dodoo_execute' ]; then
    echo "$SELF: dodoo_execute is an internal command."
    exit 1
fi
$SUBCOMMAND ${POSITIONAL[@]}
CODE=$?
if [ $CODE -ne 0 ]; then
    echo -e "\e[36m\e[1m:: Usage:\e[0m"
    echo "Working on it :D"
    exit $CODE
fi
